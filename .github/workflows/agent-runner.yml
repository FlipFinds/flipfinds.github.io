name: Agent Runner

on:
  workflow_dispatch:
    inputs:
      run_mode:
        description: "observe (report only) or propose (prepare repo updates + PR)"
        required: true
        default: observe
        type: choice
        options:
          - observe
          - propose
  schedule:
    - cron: "17 13 * * *"

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: agent-runner
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Resolve mode
        id: mode
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "schedule" ]; then
            echo "value=observe" >> "$GITHUB_OUTPUT"
          else
            echo "value=${{ github.event.inputs.run_mode }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: "0.156.0"
          extended: true

      - name: Generate proposal artifacts
        if: steps.mode.outputs.value == 'propose'
        id: proposal
        shell: bash
        run: |
          set -euo pipefail
          TS="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          DAY="$(date -u +"%Y-%m-%d")"
          RUN_ID="${{ github.run_id }}"

          mkdir -p content/posts
          POST_PATH="content/posts/agent-growth-playbook-${DAY}-${RUN_ID}.md"
          printf '%s\n' \
            '+++' \
            "title = \"FlipFinds Growth Playbook Snapshot - ${DAY}\"" \
            "date = ${TS}" \
            'draft = true' \
            'description = "Autogenerated draft with zero-spend growth experiments for review."' \
            'tags = ["growth", "automation", "draft"]' \
            'categories = ["Posts"]' \
            '+++' \
            '' \
            'This draft was generated by the Agent Runner in `propose` mode.' \
            '' \
            '## Objective' \
            'Identify practical, zero-spend growth actions for FlipFinds this week.' \
            '' \
            '## Suggested Experiments' \
            '1. Publish one educational reseller post with a data-backed headline.' \
            '2. Cross-post a condensed version to one community channel.' \
            '3. Add one dashboard KPI update explaining what changed and why.' \
            '' \
            '## Requested Approval' \
            '- No paid actions requested in this draft.' \
            '- If external account creation becomes necessary, tag the PR with `needs-approval`.' \
            > "${POST_PATH}"

          jq -n \
            --arg ts "${TS}" \
            --arg run_id "${RUN_ID}" \
            --arg trigger "${{ github.event_name }}" \
            --arg branch "${{ github.ref_name }}" \
            '{
              mode: "propose",
              lastRunAt: $ts,
              lastRunStatus: "proposal_generated",
              lastRunTrigger: $trigger,
              lastRunId: $run_id,
              lastRunBranch: $branch,
              recentActions: [
                {
                  at: $ts,
                  type: "proposal",
                  status: "completed",
                  message: "Generated draft content and prepared PR."
                },
                {
                  at: $ts,
                  type: "policy",
                  status: "completed",
                  message: "Approval-gated workflow remained in repo-only scope."
                }
              ],
              nextPlannedActions: [
                "Wait for PR review and merge decision.",
                "Run observe mode on schedule for status reporting.",
                "Prepare next proposal batch with dashboard updates."
              ]
            }' > data/agent_state.json

          jq \
            --arg ts "${TS}" \
            --arg run_id "${RUN_ID}" \
            --arg mode "propose" \
            '.generatedAt = $ts
            | .agent.mode = $mode
            | .agent.status = "active"
            | .agent.lastRunId = $run_id
            | .agent.lastRunAt = $ts
            | .agent.lastRunResult = "proposal_generated"
            | .activity = ([{"at": $ts, "kind": "proposal", "summary": "Agent generated proposal artifacts."}] + ((.activity // []) | .[0:9]))' \
            data/dashboard.json > data/dashboard.json.tmp
          mv data/dashboard.json.tmp data/dashboard.json

          echo "post_path=${POST_PATH}" >> "$GITHUB_OUTPUT"

      - name: Observe summary data
        if: steps.mode.outputs.value == 'observe'
        id: observe
        shell: bash
        run: |
          TS="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          echo "observed_at=${TS}" >> "$GITHUB_OUTPUT"

      - name: Validate site build
        run: hugo --gc --minify

      - name: Detect changes
        if: steps.mode.outputs.value == 'propose'
        id: changes
        shell: bash
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Create pull request
        if: steps.mode.outputs.value == 'propose' && steps.changes.outputs.has_changes == 'true'
        id: create_pr
        uses: peter-evans/create-pull-request@v6
        with:
          branch: agent/proposal-${{ github.run_id }}
          delete-branch: true
          title: "chore(agent): proposal batch ${{ github.run_id }}"
          commit-message: "chore(agent): generate proposal batch ${{ github.run_id }}"
          body: |
            ## Agent Proposal Batch
            - mode: propose
            - run id: `${{ github.run_id }}`
            - trigger: `${{ github.event_name }}`

            ## Included changes
            - generated draft content under `content/posts/`
            - updated `data/agent_state.json`
            - updated `data/dashboard.json`

            ## Approval gate
            If any external account creation or paid action is needed, add label `needs-approval`.

      - name: Agent summary
        shell: bash
        run: |
          MODE="${{ steps.mode.outputs.value }}"
          echo "## Agent Runner" >> "$GITHUB_STEP_SUMMARY"
          echo "- Mode: ${MODE}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Trigger: ${{ github.event_name }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Run ID: ${{ github.run_id }}" >> "$GITHUB_STEP_SUMMARY"
          if [ "$MODE" = "observe" ]; then
            echo "- Status: observe completed (read-only)" >> "$GITHUB_STEP_SUMMARY"
            echo "- Observed at: ${{ steps.observe.outputs.observed_at }}" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "- Status: propose completed" >> "$GITHUB_STEP_SUMMARY"
            echo "- Changes detected: ${{ steps.changes.outputs.has_changes }}" >> "$GITHUB_STEP_SUMMARY"
            echo "- Draft generated: ${{ steps.proposal.outputs.post_path }}" >> "$GITHUB_STEP_SUMMARY"
            echo "- Proposal PR: ${{ steps.create_pr.outputs.pull-request-url }}" >> "$GITHUB_STEP_SUMMARY"
          fi
